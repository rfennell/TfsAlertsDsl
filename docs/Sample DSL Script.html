<div class="wikidoc">
<h3>Sample DSL Script</h3>
<p>The web service is configured to run a script (<a href="https://tfsalertsdsl.codeplex.com/wikipage?title=Configuration">via the web.config</a>) when the service end point is called. The path to this script file path is define as for the&nbsp;<a href="https://tfsalertsdsl.codeplex.com/wikipage?title=Email%20Template">email
 template</a>&nbsp;.</p>
<p>The script is written in IronPython if the general form</p>
<blockquote>
<pre>import sys<br><font color="#008000"># Expect 2 args the event type and a value unique ID<br></font>LogInfoMessage( &quot;The following arguments were passed&quot; )<br>LogInfoMessage( sys.argv )<br>if sys.argv[0] == &quot;BuildEvent&quot; : <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage (&quot;A build event &quot; &#43; sys.argv[1])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#008000">&nbsp;&nbsp;&nbsp; # a sample for using the DSL to create a work item is<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>&nbsp;&nbsp; fields = {&quot;Title&quot;: &quot;The Title&quot;,&quot;Effort&quot;: 2, &quot;Description&quot;: &quot;The description of the bug&quot;}<br>&nbsp;&nbsp;       teamproject = &quot;Scrum (TFVC)&quot;<br>      <br>&nbsp;&nbsp;       wi = CreateWorkItem(teamproject ,&quot;bug&quot;,fields)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage (&quot;Work item '&quot; &#43; str(wi.Id) &#43; &quot;' has been created with the title '&quot; &#43; wi.Title &#43;&quot;'&quot;)<br>elif sys.argv[0] == &quot;WorkItemEvent&quot; :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage (&quot;A wi event &quot; &#43; sys.argv[1])<br>elif sys.argv[0] == &quot;CheckInEvent&quot; :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage (&quot;A checkin event &quot; &#43; sys.argv[1])<br>else:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage (&quot;Was not expecting to get here&quot;)</pre>
</blockquote>
<h3>Examples</h3>
<p>The best documentation for the script usage can be found the unit test project. Some usable &lsquo;production&rsquo; scripts are shown below</p>
<p><em><strong>Note</strong>: The WIKI layout may alter the indenting in these samples due to line wrapping, so use some common sense</em></p>
<h4>sendtemplatedemail.py</h4>
<p>This sends a <a href="https://tfsalertsdsl.codeplex.com/wikipage?title=Email%20Template">
template based HTML format email </a>that can include any work item fields</p>
<blockquote>
<pre><font face="Courier New">import sys<br># Expect 2 args the event type and a WI id<br>if sys.argv[0] == &quot;WorkItemEvent&quot; : <br>&nbsp;&nbsp;&nbsp; wi = int(sys.argv[1])<br>&nbsp;&nbsp;&nbsp; dumpAllWorkItemFields = True<br>&nbsp;&nbsp;&nbsp; dumpAllAlertFields = True<br>&nbsp;&nbsp;&nbsp; showMissingFieldNames = True<br>&nbsp;&nbsp;&nbsp; SendEmail(wi, CurrentScriptFolder() &#43; &quot;\EmailTemplate.htm&quot;, dumpAllWorkItemFields, dumpAllAlertFields, showMissingFieldNames)<br>&nbsp;&nbsp;&nbsp; LogInfoMessage(&quot;Sending email for work item &quot; &#43; str(wi))<br>else:<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(&quot;Was not expecting to get here&quot;)<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(sys.argv)</font></pre>
</blockquote>
<h4>setbuildretensionbyquality.py</h4>
<p>This sends an email based on the quality of a build and also sets the retention&nbsp; policy.</p>
<blockquote>
<pre><font face="Courier New">import sys<br># Expect 2 args the event type and a value unique ID for the build<br>if sys.argv[0] == &quot;BuildEvent&quot; : <br>&nbsp;&nbsp;&nbsp; uri = sys.argv[1]<br>&nbsp;&nbsp;&nbsp; build = GetBuildDetails(uri)<br>&nbsp;&nbsp;&nbsp; if build.Quality == &quot;Test Failed&quot; or build.Quality == &quot;Rejected&quot; : <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keepForever = False<br>&nbsp;&nbsp;&nbsp; else:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keepForever = True<br>&nbsp;&nbsp;&nbsp; SetBuildRetension(uri, keepForever)<br>&nbsp;&nbsp;&nbsp; msg = &quot;'&quot; &#43; build.BuildNumber &#43; &quot;' retension set to '&quot; &#43; str(keepForever) &#43; &quot;' as quality was changed to '&quot; &#43; build.Quality &#43;&quot;'&quot;<br>&nbsp;&nbsp;&nbsp; SendEmail(&quot;richard@typhoontfs&quot;,build.BuildNumber &#43; &quot; quality changed&quot;, msg)<br>&nbsp;&nbsp;&nbsp; LogInfoMessage(msg)<br>else:<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(&quot;Was not expecting to get here&quot;)<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(sys.argv)</font></pre>
</blockquote>
<p>&nbsp;</p>
<h4>changeparentworkitemstate.py</h4>
<p>Performs a roll up state change on a parent work item, setting it to done when all the child work items are done</p>
<blockquote>
<pre><font face="Courier New">import sys<br># Expect 2 args the event type and a value unique ID for the wi<br>if sys.argv[0] == &quot;WorkItemEvent&quot; : <br>&nbsp;&nbsp;&nbsp; wi = GetWorkItem(int(sys.argv[1]))<br>&nbsp;&nbsp;&nbsp; parentwi = GetParentWorkItem(wi)<br>&nbsp;&nbsp;&nbsp; if parentwi == None:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage(&quot;Work item '&quot; &#43; str(wi.Id) &#43; &quot;' has no parent&quot;)<br>&nbsp;&nbsp;&nbsp; else:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage(&quot;Work item '&quot; &#43; str(wi.Id) &#43; &quot;' has parent '&quot; &#43; str(parentwi.Id) &#43; &quot;'&quot;)</font>
<font face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; results = [c for c in GetChildWorkItems(parentwi) if c.State != &quot;Done&quot;]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if len(results) == 0:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage(&quot;All child work items are 'Done'&quot;)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parentwi.State = &quot;Done&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UpdateWorkItem(parentwi)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg = &quot;Work item '&quot; &#43; str(parentwi.Id) &#43; &quot;' has been set as 'Done' as all its child work items are done&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendEmail(&quot;richard@typhoontfs&quot;,&quot;Work item '&quot; &#43; str(parentwi.Id) &#43; &quot;' has been updated&quot;, msg)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage(msg)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage(&quot;Not all child work items are 'Done'&quot;)<br>else:<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(&quot;Was not expecting to get here&quot;)<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(sys.argv)</font></pre>
</blockquote>
<h4>incrementbuildversion.py</h4>
<p>Updates the minor version number when a built is set to the released state</p>
<blockquote>
<pre><font face="Courier New">import sys<br># Expect 2 args the event type and a value unique ID for the build<br>if sys.argv[0] == &quot;BuildEvent&quot; : <br>&nbsp;&nbsp;&nbsp; uri = sys.argv[1]<br>&nbsp;&nbsp;&nbsp; build = GetBuildDetails(uri)<br>&nbsp;&nbsp;&nbsp; if build.Quality == &quot;Released&quot; : <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IncrementBuildNumber(uri)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg = &quot;'&quot; &#43; build.BuildDefinition.Name &#43; &quot;' version incremented to &quot; &#43; GetVersionNumber(uri) &#43; &quot; as last build quality set to '&quot; &#43; build.Quality &#43;&quot;'&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendEmail(&quot;richard@typhoontfs&quot;,build.BuildDefinition.Name &#43; &quot; version incremented&quot;, msg)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogInfoMessage(msg)<br>else:<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(&quot;Was not expecting to get here&quot;)<br>&nbsp;&nbsp;&nbsp; LogErrorMessage(sys.argv)</font></pre>
</blockquote>
</div><div class="ClearBoth"></div>
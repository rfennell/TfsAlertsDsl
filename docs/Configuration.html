<div class="wikidoc">
<h3>Configuration</h3>
<h4>Distribution Media</h4>
<p>The service can be shipped as a file system package. Which has been built and&nbsp;ZIP&rsquo;d into a single file for ease of distribution in the
<a href="https://tfsalertsdsl.codeplex.com/releases">downloads area</a>&nbsp;(the solution also allows the building of a MSDeploy package)</p>
<p>The service can be built as a MSDeploy package. This can be installed in a variety of ways i.e. IIS Manager or command line, and into a dedicated web site or virtual application. The choice is yours at installation time.</p>
<p>This documentation assumes installation into a dedicated web site on your TFS server using the IIS Manager UI. You can however place the DSL endpoint on any IIS server your TFS server can see.&nbsp;</p>
<p>Note that if placing the DSL endpoint on the same server as the TFS AT you need to&nbsp;<a href="http://blogs.blackmarble.co.uk/blogs/rfennell/post/2015/08/13/TF30063-Errors-accessing-a-TFS-2015-server-via-the-C-API-after-upgrade-from-2013.aspx">consider
 Windows Loopback protection</a></p>
<p>Note that you can setup this service to make use of SSL or an existing site, this will require some additional setup steps, details of these can be found on Microsoft IIS documentation sites.</p>
<ol>
<li>On the TFS Server login as an admin user and load IIS Manager </li><li>Expand the site section on the left </li><li>Right click to add a new site </li><li>Enter a name for the site e.g.TfsAlertService, notice that a new AppPool is created with the same name. (You can change the AppPool to make use of an existing AppPool if you want)
</li><li>Provide a physical path as the root folder for the web site e.g. c:\inetpub\TfsAlertService
</li><li>Select the port you wish to use for the site e.g. 8888 </li><li>You can confirm the values entered using the sites advanced settings and site bindings<br>
<strong>REMEMBER TO MAKE SURE THE FIREWALL DOES NOT BLOCK THE PORT YOU CHOOSE</strong>
</li><li>Save this new site settings </li><li>In the AppPool settings find the newly create AppPool and edit its advanced settings to make sure that:
<ul>
<li>It is running .NET 4.0 Integrated (default is usually .NET 2.0) </li><li>In the advanced settings
<ul>
<li>Enable 32bit application is set to - True </li><li>The Identity is a user account that has rights to access TFS. You can do this by granting TFS rights to a build in account such as NetworkService, but it is probably better to a use a domain account. The TFSService account is a good choice as this already
 has all the rights it needs </li></ul>
</li></ul>
</li><li>Once this is saved you should now have a new site to install your application into using MSDeploy, this can be done using the UI or command line
</li><li>Via the UI
<ul>
<li>In IIS Manager select the newly created site. </li><li>On the right hand side of the application select the Deploy, import application
</li><li>Select the provide MSDeploy ZIP based package file (not the ZIP distribution emailed out, but the inner zip it contains)
</li><li>Select the default options </li><li>Clear the application path field, and acknowledge the warning that &lsquo;most applications are installed on folder&rsquo;. You can of course install the application into a folder, the only effect is it will alter the service URL.
</li><li>The application will then be installed </li></ul>
</li><li>Via the command line (alternative)
<ul>
<li>To perform a command line installation see the reference section of this document for link, but basically run the &ldquo;TFSAlertrocessor.deploy.cmd&rsquo; PowerShell command to trigger MSDeploy with the parameters stored in the supporting files. The associated
 readme file provides more details. </li></ul>
</li><li>
<p>If not using MSDeploy</p>
<ul>
<li>Unzip the file system distribution and place the files in the root of the new new site.
</li></ul>
</li></ol>
<h4>DSL Library</h4>
<p>The main distribution media <strong>DOES NOT</strong> ship with an actual DSL library. This is because there is a good chance you will want to create your own.&nbsp; So you therefore have three options</p>
<ul>
<li>Create your own using samples provided </li><li>Download this projects&nbsp;source and build the provided reference implementation
</li><li><strong>THE EASIST OPTION </strong>- Download the <strong>TFSEventsProcessor.Dsl.dll</strong> implementation from the same page as the main release
</li></ul>
<p>Whichever option (or options, remember you can have multiple DSL libraries loaded at the same time) you choose place the DLL(s)&nbsp;in the folder specified in the web.config (see below)</p>
<h4>Web.Config (usually done once)</h4>
<p>All the service configuration is done via the IIS server web.config installed by MSDeploy into in the web site physical folder created in the previous steps. This can be edited manually as needed using Notepad or any other text editor.</p>
<p>You should not need to edit any of the WCF settings unless changing to SSL based communications.</p>
<blockquote>
<pre>&lt;appSettings&gt;<br><font color="#4bacc6"><font color="#008000">&lt;!-- The domain name to append to the user names associated with work items &ndash;&gt;</font><br></font>&lt;add key=&quot;EmailDomain&quot; value=&quot;mydomain.com&quot;/&gt;<br><font color="#008000">&lt;!-- If true logging will occur to the System.Diagnostics.Trace and incoming events are saved to the LoggingFolder &ndash;&gt;<br></font>&lt;add key=&quot;LogEventsToFile&quot; value=&quot;True&quot;/&gt;<br><font color="#008000">&lt;!-- The folder that the service will use for a TFS Cache (needs read/write access)&mdash;&gt;<br></font>&lt;add key=&quot;WorkItemTrackingCacheRoot&quot; value=&quot;C:\windows\temp&quot;/&gt;<br><font color="#008000">&lt;!-- The folder the incomming alerts will be dumped to if requested &ndash;&gt;<br></font>&lt;add key=&quot;LoggingFolder&quot; value=&quot;C:\windows\temp&quot;/&gt;<br><font color="#008000">&lt;!-- Address of SMTP server used to send email &ndash;&gt;<br></font>&lt;add key=&quot;SMTPServer&quot; value=&quot;mail.mydomain.com&quot;/&gt;<br><font color="#008000">&lt;!-- The email address that email should be sent from &ndash;&gt;<br></font>&lt;add key=&quot;FromEmail&quot; value=&quot;tfsalert@mydomain.com&quot;/&gt;<br><font color="#008000">&lt;!-- The script to run when event raised either fill path or script name. V 1.1.x.x and later, if left blank it will try to use a script in the form '[eventname].py'&mdash;&gt;<br></font>&lt;add key=&quot;ScriptFile&quot; value=&quot; script.py&quot;/&gt;<br><font color="#008000">&lt;!-- The location to load DSL library from if no full path is used for the scriptfile entry&mdash;&gt;<br></font>&lt;add key=&quot;DSLFolder&quot; value=&quot;C:\inetpub\TfsDslService\bin\DSL&quot;/&gt;<br><font color="#008000">&lt;!-- The location to load DSL library from--&gt;<br></font>&lt;add key=&quot;ScriptFolder&quot; value=&quot;C:\inetpub\TfsDslService\Scripts&quot;/&gt;<br>&lt;/appSettings&gt;</pre>
<p>&nbsp;</p>
</blockquote>
<h4>Registering Alerts</h4>
<h5>Using the Command Line</h5>
<p>The easiest way to use the service is to configure TFS to send the alert message whenever something changes irrespective of the user. In this example the service will be called when any work item is changed</p>
<p>For this form of setup the command line tools on the TFS server can be used</p>
<blockquote>
<p>&quot;C:\Program Files\Microsoft Team Foundation Server 2012\Tools\bissubscribe&quot; /eventType WorkItemChangedEvent /address
<a href="http://localhost:8888/TfsAlertService.svc">http://localhost:8888/TfsAlertService.svc</a> /collection
<a href="http://localhost:8080/tfs/DefaultCollection">http://localhost:8080/tfs/DefaultCollection</a></p>
</blockquote>
<p>Note:</p>
<ul>
<li>We can use the server name localhost as both TFS and the service are on the same box in this example.
</li><li>If you have multiple team project collection you need to register each one separately
</li></ul>
<p>When the alert is registered you will be told a unique ID. The alert can be unsubscribed from the command line using the command</p>
<blockquote>
<p>&quot;C:\Program Files\Microsoft Team Foundation Server 2012\Tools\bissubscribe&quot; /unsubscribe /id [the number]</p>
</blockquote>
<p>Using the TFS Web Site</p>
<p>In many cases it will be easier to configure the alerts via the Alert Explorer in the TFS Web site. To do this:</p>
<ol>
<li>Open <a href="http://mytfsserver:8080/tfs">http://mytfsserver:8080/tfs</a> </li><li>Select a Team Project </li><li>Select the the settings (cog top right) </li><li>Select the Alerts tab<br>
Press the New Alert Button </li><li>Select one of the alert templates (for the Work item alerts), this selects the basic filters. If you don&rsquo;t want a filter (in effect the same as the command line subscription) pick blank alert
</li><li>Provide the alert a name </li><li>On the alert definition tab set the
<ol>
<li>Formatting: to SOAP </li><li>Send to: to the WCF end point URL e.g. <a href="http://localhost:8888/TfsDslService.svc">
http://localhost:8888/TfsDslService.svc</a> </li></ol>
</li><li>Save the alerts </li></ol>
<p>Once the alert is registered, perform whatever action the alert traps and you should see the script being run.</p>
<p>If the script is not run use the techniques detailed in the <a href="https://tfsalertsdsl.codeplex.com/wikipage?title=Debugging">
debug section</a>.</p>
<p><strong>TOP TIPS</strong></p>
<ul>
<li>Make sure the URL you used in the alert registration matches the one for the actual IIS web site, typo's are easy to make.
</li><li>If you are hosting the DSL endpoint on the same server as the TFS AT make sure Windows Loopback protection is disabled else you could get a TF30063 error -&nbsp;<a href="http://blogs.blackmarble.co.uk/blogs/rfennell/post/2015/08/13/TF30063-Errors-accessing-a-TFS-2015-server-via-the-C-API-after-upgrade-from-2013.aspx">For
 details see this post</a> </li></ul>
</div><div class="ClearBoth"></div>